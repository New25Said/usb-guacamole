<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Propiedades de Unidad USB</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --win-gray: #f0f0f0;
            --win-border: #a0a0a0;
            --win-blue: #0078d7;
        }

        body {
            background-color: #005a9e;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-size: 11px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .window {
            width: 380px;
            background: var(--win-gray);
            border: 1px solid #666;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            padding: 2px;
        }

        /* Tabs estilo Windows */
        .tabs-header {
            display: flex;
            padding: 5px 5px 0 5px;
            gap: 2px;
        }

        .tab {
            padding: 4px 12px;
            border: 1px solid var(--win-border);
            border-bottom: none;
            background: #e1e1e1;
            cursor: pointer;
        }

        .tab.active {
            background: white;
            margin-bottom: -1px;
            z-index: 2;
            padding-bottom: 5px;
        }

        .content-area {
            background: white;
            border: 1px solid var(--win-border);
            margin: 0 5px 5px 5px;
            padding: 15px;
            height: 420px;
            overflow-y: auto;
        }

        /* Detalles de Almacenamiento */
        .drive-info-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .label-text { width: 100px; color: #333; }
        .value-text { font-weight: bold; color: #000; }

        .separator { height: 1px; background: #ccc; margin: 10px 0; }

        .chart-box {
            width: 150px;
            height: 150px;
            margin: 10px auto;
        }

        /* Tabla de Hardware */
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; background: #f0f0f0; border: 1px solid #ccc; padding: 4px; }
        td { border: 1px solid #eee; padding: 4px; }

        .loading-bar {
            width: 100%;
            height: 15px;
            background: #eee;
            border: 1px solid #ccc;
            position: relative;
            display: none;
        }
        .progress { width: 0%; height: 100%; background: #0078d7; }

        .footer-btns {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 10px;
            background: var(--win-gray);
        }

        button { padding: 4px 15px; min-width: 75px; }
    </style>
</head>
<body>

<div class="window">
    <div class="tabs-header">
        <div class="tab active" onclick="showTab('general')">General</div>
        <div class="tab" onclick="showTab('hardware')">Hardware</div>
        <div class="tab" onclick="showTab('info')">Análisis</div>
    </div>
    
    <div class="content-area" id="main-content">
        <div id="tab-general">
            <div class="drive-info-row">
                <img src="https://img.icons8.com/color/48/000000/usb-memory-stick.png" width="32">
                <input type="text" id="driveName" value="Unidad USB" style="margin-left:10px; width: 70%">
            </div>
            <div class="separator"></div>
            
            <div class="drive-info-row">
                <span class="label-text">Tipo:</span>
                <span class="value-text">Dispositivo de almacenamiento extraíble</span>
            </div>
            <div class="drive-info-row">
                <span class="label-text">Sistema de archivos:</span>
                <span id="fs-type" class="value-text">Desconocido (Escanea para ver)</span>
            </div>

            <div class="separator"></div>

            <div class="drive-info-row">
                <span><div style="width:12px;height:12px;background:blue;display:inline-block;border:1px solid #000;margin-right:5px"></div>Espacio usado:</span>
                <span id="used-txt" class="value-text">0 bytes</span>
            </div>
            <div class="drive-info-row">
                <span><div style="width:12px;height:12px;background:magenta;display:inline-block;border:1px solid #000;margin-right:5px"></div>Espacio libre:</span>
                <span id="free-txt" class="value-text">Pendiente...</span>
            </div>

            <div class="chart-box">
                <canvas id="winChart"></canvas>
            </div>
        </div>

        <div id="tab-hardware" style="display:none">
            <p>Dispositivos encontrados:</p>
            <table>
                <thead><tr><th>Nombre</th><th>Tipo</th></tr></thead>
                <tbody id="hw-list">
                    <tr><td>Cargando...</td><td>Genérico</td></tr>
                </tbody>
            </table>
        </div>

        <div id="tab-info" style="display:none">
            <h3>Análisis Profundo</h3>
            <p>Presiona el botón para escanear el contenido real del USB.</p>
            <button onclick="scanUSB()" style="width:100%">Escanear Archivos</button>
            <div class="loading-bar" id="lbar"><div class="progress" id="pbar"></div></div>
            <ul id="file-details" style="margin-top:10px; font-size: 10px;"></ul>
        </div>
    </div>

    <div class="footer-btns">
        <button onclick="location.reload()">Aceptar</button>
        <button onclick="window.close()">Cancelar</button>
    </div>
</div>

<script>
    let chart;
    let totalBytesUsed = 0;
    let fileCount = 0;

    function showTab(tabName) {
        document.getElementById('tab-general').style.display = tabName === 'general' ? 'block' : 'none';
        document.getElementById('tab-hardware').style.display = tabName === 'hardware' ? 'block' : 'none';
        document.getElementById('tab-info').style.display = tabName === 'info' ? 'block' : 'none';
        
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // FUNCIÓN PARA ESCANEAR ARCHIVOS REALES
    async function scanUSB() {
        try {
            const dirHandle = await window.showDirectoryPicker();
            document.getElementById('lbar').style.display = 'block';
            document.getElementById('driveName').value = dirHandle.name;
            
            totalBytesUsed = 0;
            fileCount = 0;
            const details = document.getElementById('file-details');
            details.innerHTML = "Analizando...";

            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    totalBytesUsed += file.size;
                    fileCount++;
                }
            }

            const usedGB = (totalBytesUsed / (1024**3)).toFixed(4);
            const totalSimulated = 16; // Seguimos simulando el total porque el navegador no da el tamaño del hardware
            const freeGB = (totalSimulated - usedGB).toFixed(4);

            document.getElementById('used-txt').innerText = `${usedGB} GB (${totalBytesUsed.toLocaleString()} bytes)`;
            document.getElementById('free-txt').innerText = `${freeGB} GB`;
            details.innerHTML = `<li>Archivos encontrados: ${fileCount}</li><li>Peso total real: ${usedGB} GB</li>`;
            
            updateChart(usedGB, freeGB);
            updateHardware(dirHandle.name);

        } catch (err) {
            alert("Error al escanear: " + err.message);
        }
    }

    function updateHardware(name) {
        const list = document.getElementById('hw-list');
        list.innerHTML = `<tr><td>${name} Flash Disk</td><td>USB Mass Storage</td></tr>
                          <tr><td>Generic USB Hub</td><td>Controlador</td></tr>`;
    }

    function updateChart(used, free) {
        const ctx = document.getElementById('winChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'pie',
            data: {
                datasets: [{
                    data: [used, free],
                    backgroundColor: ['#0000ff', '#ff00ff'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // Inicializar gráfica vacía
    updateChart(0, 100);
</script>
</body>
</html>
